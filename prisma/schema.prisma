generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

/// Usuarios con Auth.js
model User {
  email                  String           @unique
  name                   String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  id                     String           @id @default(cuid())
  password               String
  emailVerified          DateTime?
  image                  String?
  isActive               Boolean          @default(true)
  lastLoginAt            DateTime?
  role                   UserRole         @default(VIEWER)
  accounts               Account[]
  approvals              Approval[]       @relation("UserApprovals")
  auditLogs              AuditLog[]       @relation("UserAuditLogs")
  deliveryBatches        DeliveryBatch[]  @relation("UserDeliveryBatches")
  requests               Request[]        @relation("UserRequests")
  returnBatches          ReturnBatch[]    @relation("UserReturnBatches")
  sessions               Session[]
  approvedStockMovements StockMovement[]  @relation("ApprovedStockMovements")
  stockMovements         StockMovement[]  @relation("UserStockMovements")
  permissions            UserPermission[]

  @@index([email])
  @@index([role])
}

/// Auth.js Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

/// Auth.js Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// Auth.js Verification Token model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// Sistema de permisos granulares
model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  module      String
  createdAt   DateTime         @default(now())
  users       UserPermission[]

  @@index([module])
}

/// Relación Usuario-Permisos
model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  grantedAt    DateTime   @default(now())
  grantedBy    String?
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

/// Artículos de protección personal
model EPP {
  id           Int             @id @default(autoincrement())
  code         String          @unique @db.VarChar(32)
  name         String          @db.VarChar(128)
  category     String          @db.VarChar(64)
  subcategory  String?         @db.VarChar(64)
  description  String?
  imageUrl     String?
  datasheetUrl String?
  minStock     Int             @default(1)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @default(now()) @updatedAt
  deliveries   Delivery[]
  stocks       EPPStock[]
  requests     Request[]
  returnItems  ReturnItem[]
  movements    StockMovement[]

  @@index([name])
  @@index([category])
  @@index([subcategory])
}

/// Almacenes físicos
model Warehouse {
  id              Int             @id @default(autoincrement())
  name            String          @unique
  location        String?
  createdAt       DateTime        @default(now())
  deliveryBatches DeliveryBatch[]
  stocks          EPPStock[]
  returnBatches   ReturnBatch[]
  movements       StockMovement[]

  @@index([name])
}

/// Inventario por almacén
model EPPStock {
  eppId       Int
  warehouseId Int
  quantity    Int       @default(0)
  epp         EPP       @relation(fields: [eppId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@id([eppId, warehouseId])
}

/// Movimientos de stock
model StockMovement {
  id            Int               @id @default(autoincrement())
  type          StockMovementType
  quantity      Int
  note          String?
  createdAt     DateTime          @default(now())
  eppId         Int
  warehouseId   Int
  userId        String
  approvedAt    DateTime?
  approvedById  String?
  rejectionNote String?
  status        MovementStatus    @default(APPROVED)
  approvedBy    User?             @relation("ApprovedStockMovements", fields: [approvedById], references: [id])
  epp           EPP               @relation(fields: [eppId], references: [id])
  user          User              @relation("UserStockMovements", fields: [userId], references: [id])
  warehouse     Warehouse         @relation(fields: [warehouseId], references: [id])

  @@index([eppId, warehouseId, createdAt])
  @@index([type, createdAt])
  @@index([userId, createdAt])
  @@index([status, createdAt])
}

/// Lote de entregas
model DeliveryBatch {
  id             Int          @id @default(autoincrement())
  note           String?
  warehouseId    Int
  createdAt      DateTime     @default(now())
  code           String       @unique @db.VarChar(32)
  collaboratorId Int
  userId         String
  deliveries     Delivery[]
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id])
  user           User         @relation("UserDeliveryBatches", fields: [userId], references: [id])
  warehouse      Warehouse    @relation(fields: [warehouseId], references: [id])

  @@index([createdAt])
  @@index([collaboratorId])
  @@index([warehouseId])
}

/// Cada línea de entrega
model Delivery {
  id        Int           @id @default(autoincrement())
  batchId   Int
  eppId     Int
  quantity  Int
  createdAt DateTime      @default(now())
  batch     DeliveryBatch @relation(fields: [batchId], references: [id])
  epp       EPP           @relation(fields: [eppId], references: [id])

  @@index([batchId, eppId])
  @@index([createdAt])
  @@index([batchId, eppId], map: "idx_delivery_epp_batch")
}

/// Lote de devoluciones
model ReturnBatch {
  id          Int          @id @default(autoincrement())
  code        String       @unique @db.VarChar(32)
  warehouseId Int
  note        String?
  createdAt   DateTime     @default(now())
  userId      String
  user        User         @relation("UserReturnBatches", fields: [userId], references: [id])
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id])
  items       ReturnItem[]

  @@index([createdAt])
}

/// Cada línea de devolución
model ReturnItem {
  id        Int               @id @default(autoincrement())
  batchId   Int
  eppId     Int
  quantity  Int
  condition DeliveryCondition
  createdAt DateTime          @default(now())
  batch     ReturnBatch       @relation(fields: [batchId], references: [id])
  epp       EPP               @relation(fields: [eppId], references: [id])

  @@index([batchId, eppId])
  @@index([createdAt])
  @@index([batchId, eppId], map: "idx_return_item_batch_epp")
}

/// Solicitudes de EPP
model Request {
  id        Int           @id @default(autoincrement())
  employee  String
  quantity  Int
  reason    String?
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  eppId     Int
  userId    String
  approvals Approval[]
  epp       EPP           @relation(fields: [eppId], references: [id])
  user      User          @relation("UserRequests", fields: [userId], references: [id])
}

/// Aprobaciones
model Approval {
  id        Int            @id @default(autoincrement())
  result    ApprovalResult
  comment   String?
  createdAt DateTime       @default(now())
  requestId Int
  userId    String
  request   Request        @relation(fields: [requestId], references: [id])
  user      User           @relation("UserApprovals", fields: [userId], references: [id])
}

/// Colaboradores de entregas
model Collaborator {
  id              Int             @id @default(autoincrement())
  name            String          @db.VarChar(128)
  email           String?         @db.VarChar(128)
  position        String?         @db.VarChar(64)
  documentId      String?         @db.VarChar(20)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  location        String?         @db.VarChar(128)
  deliveryBatches DeliveryBatch[]

  @@index([name])
  @@index([location])
  @@index([documentId])
}

/// Configuración general del sistema (solo un registro – id = 1)
model SystemConfig {
  id          Int      @id @default(1)
  companyName String?  @db.VarChar(128)
  logoUrl     String?  @db.VarChar(255)
  updatedAt   DateTime @updatedAt
}

/// Sistema de Auditoría - Trazabilidad completa de cambios
model AuditLog {
  id         BigInt      @id @default(autoincrement())
  action     AuditAction
  entityType String      @db.VarChar(50)
  entityId   Int
  changes    Json?
  metadata   Json?
  createdAt  DateTime    @default(now())
  expiresAt  DateTime
  userId     String
  user       User        @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([expiresAt])
  @@index([createdAt(sort: Desc)])
  @@map("AuditLog")
}

/// Enumeraciones
enum StockMovementType {
  ENTRY
  EXIT
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT
}

enum MovementStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum DeliveryCondition {
  REUSABLE
  DISCARDED
}

enum ApprovalResult {
  APPROVED
  REJECTED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum UserRole {
  ADMIN
  SUPERVISOR
  WAREHOUSE_MANAGER
  OPERATOR
  VIEWER
}
